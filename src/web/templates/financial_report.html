{% extends "base.html" %}

{% block title %}{{ report_title }}{% endblock %}

{% block head %}
<style>
  .metric-card {
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease;
  }

  .metric-card:hover {
    transform: translateY(-5px);
  }

  .income-card {
    background-color: #e3f2fd;
    border-left: 5px solid #2196f3;
  }

  .expense-card {
    background-color: #ffebee;
    border-left: 5px solid #f44336;
  }

  .savings-card {
    background-color: #e8f5e9;
    border-left: 5px solid #4caf50;
  }

  .expense-bar {
    height: 30px;
    background-color: #f44336;
    border-radius: 5px;
    margin-bottom: 10px;
  }

  .expense-label {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
  }

  .recommendation-card {
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    background-color: #fff;
    border-left: 5px solid #9c27b0;
  }

  .filter-container {
    background-color: #f5f5f5;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
  }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row mb-4">
    <div class="col-12">
      <h1 class="text-center">{{ report_title }}</h1>
      <p class="text-center text-muted">Análisis detallado de tus finanzas personales</p>
    </div>
  </div>

  <!-- Month Filter -->
  <div class="filter-container">
    <form id="monthFilterForm" class="row align-items-end">
      <div class="col-md-6">
        <label for="month" class="form-label">Filtrar por Mes</label>
        <select class="form-select" id="month" name="month">
          <option value="all" {% if selected_month=='all' %}selected{% endif %}>Todos los meses</option>
          {% for month_value, month_name in available_months %}
          <option value="{{ month_value }}" {% if selected_month==month_value %}selected{% endif %}>
            {{ month_name }}
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-6 d-flex align-items-end">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-filter"></i> Aplicar Filtro
        </button>
        <a href="{{ url_for('financial_report') }}" class="btn btn-outline-secondary ms-2">
          <i class="bi bi-x-circle"></i> Limpiar Filtro
        </a>
      </div>
    </form>
  </div>

  <!-- Financial Summary -->
  <div class="row mb-4">
    <div class="col-12">
      <h2>Resumen Financiero</h2>
      <hr>
    </div>

    <div class="col-md-4">
      <div class="metric-card income-card">
        <h4>Ingresos Totales</h4>
        <h2>{{ total_income|round(2) }} €</h2>
      </div>
    </div>

    <div class="col-md-4">
      <div class="metric-card expense-card">
        <h4>Gastos Totales</h4>
        <h2>{{ total_expenses|round(2) }} €</h2>
      </div>
    </div>

    <div class="col-md-4">
      <div class="metric-card savings-card">
        <h4>Tasa de Ahorro</h4>
        <h2>{{ savings_rate|round(1) }}%</h2>
      </div>
    </div>
  </div>

  <!-- Top Expenses -->
  <div class="row mb-4">
    <div class="col-12">
      <h2>Principales Categorías de Gastos</h2>
      <hr>
    </div>

    <div class="col-md-12">
      {% for category in top_expense_categories %}
      <div class="expense-label">
        <span>{{ category.name }}</span>
        <span>{{ category.amount|round(2) }} € ({{ category.percentage|round(1) }}%)</span>
      </div>
      <div class="expense-bar" id="expense-bar-{{ loop.index }}"></div>
      <script>
        document.getElementById('expense-bar-{{ loop.index }}').style.width = '{{ category.percentage }}%';
      </script>
      {% endfor %}
    </div>
  </div>

  <!-- Personalized Recommendations -->
  <div class="row mb-4">
    <div class="col-12">
      <h2>Recomendaciones Personalizadas</h2>
      <hr>
    </div>

    {% for recommendation in recommendations %}
    <div class="col-md-4">
      <div class="recommendation-card">
        <h4>{{ recommendation.title }}</h4>
        <p>{{ recommendation.description }}</p>
        <small class="text-muted">Fuente: {{ recommendation.source }}</small>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Financial Goals -->
  <div class="row mb-4">
    <div class="col-12">
      <h2>Objetivos Financieros Recomendados</h2>
      <hr>
    </div>

    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title">Fondo de Emergencia</h5>
          <p class="card-text">
            Ahorra entre 3-6 meses de gastos: <strong>{{ (total_expenses * 3)|round(2) }} € - {{ (total_expenses *
              6)|round(2) }} €</strong>
          </p>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title">Reducción de Gastos</h5>
          <p class="card-text">
            Intenta reducir tus gastos en las principales categorías en un 15%: <strong>{{ (total_expenses *
              0.15)|round(2) }} €</strong> mensuales
          </p>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title">Inversión a Largo Plazo</h5>
          <p class="card-text">
            Invierte al menos el 15% de tus ingresos: <strong>{{ (total_income * 0.15)|round(2) }} €</strong> mensuales
          </p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.getElementById('monthFilterForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const month = document.getElementById('month').value;
    window.location.href = "{{ url_for('financial_report') }}" + (month !== 'all' ? '/' + month : '');
  });
</script>
{% endblock %}